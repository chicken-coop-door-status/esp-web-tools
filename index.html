<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Mother Hen Egg Recovery</title>
    <meta
      name="description"
      content="Field-ready ESP Web Tools for Mother Hen Egg recovery with data-safe and factory reset paths."
    />
    <meta name="viewport" content="width=device-width" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: dark;
        --page-bg: radial-gradient(circle at top, #1b365a, transparent 45%),
          #05070c;
        --card-bg: rgba(7, 13, 26, 0.85);
        --card-border: rgba(255, 255, 255, 0.08);
        --accent: #4de7b2;
        --accent-strong: #7cc7ff;
        --text: #f6f7fb;
        --muted: rgba(246, 247, 251, 0.66);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Space Grotesk", "Segoe UI", system-ui, sans-serif;
        background: var(--page-bg);
        color: var(--text);
        line-height: 1.5;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, rgba(77, 231, 178, 0.25),
            rgba(124, 199, 255, 0.12)) no-repeat;
        pointer-events: none;
        z-index: -1;
        mix-blend-mode: screen;
      }

      .page {
        max-width: 1100px;
        margin: 0 auto;
        padding: 48px 24px 72px;
        display: flex;
        flex-direction: column;
        gap: 48px;
      }

      .hero {
        padding: 32px;
        border-radius: 24px;
        background: linear-gradient(180deg, rgba(25, 42, 71, 0.95), rgba(11, 14, 25, 0.9));
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 25px 60px rgba(5, 7, 12, 0.6);
      }

      .pill {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--accent);
        padding: 6px 14px;
        border: 1px solid rgba(77, 231, 178, 0.4);
        border-radius: 999px;
        margin-bottom: 12px;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(2.4rem, 3vw, 3.2rem);
      }

      .hero-subtitle,
      .preflight-note {
        margin: 16px 0 0;
        color: var(--muted);
      }

      .preflight-note {
        font-size: 0.95rem;
      }

      .hero-stats {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 18px;
      }

      .hero-stats div {
        padding: 18px;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      .stat-label {
        display: block;
        font-size: 0.75rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--muted);
      }

      section {
        background: rgba(5, 7, 12, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 24px;
        padding: 28px;
      }

      .field-checklist-section h2,
      .manifest-section h2,
      .notes-section h2 {
        margin-top: 0;
        margin-bottom: 8px;
        font-size: 1.8rem;
      }

      .field-checklist {
        margin-top: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
      }

      .check-card {
        border-radius: 18px;
        padding: 16px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        min-height: 120px;
      }

      .check-card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }

      .check-title {
        font-weight: 600;
        font-size: 1rem;
      }

      .check-marker {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
      }

      .manifest-grid {
        margin-top: 24px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 20px;
      }

      .manifest-card {
        border-radius: 20px;
        padding: 22px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        display: flex;
        flex-direction: column;
        gap: 16px;
        backdrop-filter: blur(12px);
      }

      .manifest-card .card-head {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .card-badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 12px;
        border-radius: 999px;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--accent);
        border: 1px solid rgba(77, 231, 178, 0.4);
        margin-bottom: 6px;
      }

      .card-summary {
        margin: 4px 0 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .card-version {
        font-weight: 600;
        color: var(--accent-strong);
        font-size: 0.9rem;
      }

      .card-note {
        font-size: 0.85rem;
        color: var(--muted);
      }

      .card-cta {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .card-hint {
        margin: 0;
        font-size: 0.75rem;
        color: rgba(246, 247, 251, 0.46);
        word-break: break-all;
      }

      .device-selector-btn {
        width: 100%;
        padding: 16px 20px;
        border: 2px solid var(--card-border);
        border-radius: 12px;
        background: var(--card-bg);
        color: var(--text);
        font-family: inherit;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .device-selector-btn:hover {
        border-color: rgba(77, 231, 178, 0.4);
        background: rgba(77, 231, 178, 0.05);
      }

      .device-selector-btn.selected {
        border-color: var(--accent);
        background: rgba(77, 231, 178, 0.1);
        box-shadow: 0 0 0 1px var(--accent);
      }

      .device-selector-card {
        border-radius: 20px;
        padding: 22px;
        background: var(--card-bg);
        border: 2px solid var(--card-border);
        display: flex;
        flex-direction: column;
        gap: 12px;
        backdrop-filter: blur(12px);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .device-selector-card:hover {
        border-color: rgba(77, 231, 178, 0.4);
        background: rgba(77, 231, 178, 0.05);
      }

      .device-selector-card.selected {
        border-color: var(--accent);
        background: rgba(77, 231, 178, 0.1);
        box-shadow: 0 0 0 1px var(--accent);
      }

      .device-selector-card h3 {
        margin: 0;
        font-size: 1.3rem;
      }

      .device-selector-card p {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .section-heading {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
      }

      .section-heading p {
        margin: 0;
        color: var(--muted);
      }

      .notes-section ul {
        padding-left: 20px;
        margin: 0;
        list-style: disc;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .notes-section li {
        color: var(--muted);
        font-size: 0.95rem;
      }

      .error-banner {
        color: #ff7a7a;
        margin-top: 12px;
        font-weight: 500;
        visibility: hidden;
      }

      .has-error + .error-banner,
      .error-banner:not(:empty) {
        visibility: visible;
      }

      @media (max-width: 600px) {
        .hero-stats {
          grid-template-columns: 1fr;
        }

        section {
          padding: 20px;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        * {
          transition: none !important;
        }
      }
    </style>
  </head>
  <body>
    <main class="page">
      <header class="hero">
        <span class="pill">Mother Hen Field Tools</span>
        <h1 id="hero-title">ESP Web Tools – Device Recovery</h1>
        <p id="hero-description" class="hero-subtitle">
          Field-focused instructions for Chrome/Edge recovery of ESP32-S3 devices.
        </p>
        <p id="preflight" class="preflight-note">
          Preflight: the browser checks for WebSerial support before continuing.
        </p>
        <div class="hero-stats">
          <div>
            <span class="stat-label">Device type</span>
            <strong id="device-type-display">Select device below</strong>
          </div>
          <div>
            <span class="stat-label">Chip family</span>
            <strong id="chip-family">ESP32-S3</strong>
          </div>
          <div>
            <span class="stat-label">Manifest host</span>
            <strong>ota-charlies-farm (us-east-2)</strong>
          </div>
        </div>
      </header>

      <section class="device-selector-section">
        <header>
          <h2>Device selection</h2>
          <p>
            Choose which Mother Hen device you're recovering, then follow the field checklist and flash instructions below.
          </p>
        </header>
        <div id="device-selector-grid" class="manifest-grid">
          <div class="manifest-card">
            <p>Loading devices…</p>
          </div>
        </div>
      </section>

      <section class="field-checklist-section">
        <header>
          <h2>Field checklist</h2>
          <p>
            Follow the steps below before you plug the device into your laptop. The
            UI enforces the chip family and will warn if the browser or cable
            doesn't expose WebSerial.
          </p>
        </header>
        <div class="field-checklist" id="field-checklist-grid">
          <div class="check-card">
            <p>Loading checklist…</p>
          </div>
        </div>
      </section>

      <section class="manifest-section">
        <div class="section-heading">
          <div>
            <h2>Recovery paths</h2>
            <p>
              Choose a manifest, then hit Connect. ESP Web Tools detects the
              ESP32-S3, flashes the selected image, and (optionally) prompts you
              before erasing.
            </p>
          </div>
          <div class="section-note">
            <p>
              Need to protect provisioning? Use the recovery path and skip the
              erase checkbox in the dialog.
            </p>
          </div>
        </div>
        <div id="manifest-grid" class="manifest-grid">
          <article class="manifest-card">
            <div class="card-head">
              <div>
                <p class="card-badge">Loading</p>
                <h3>Loading…</h3>
              </div>
              <p class="card-version">–</p>
            </div>
            <p class="card-note">Fetching manifests and the Web Tools component.</p>
          </article>
        </div>
        <p id="error-message" class="error-banner" aria-live="assertive"></p>
      </section>

      <section class="notes-section">
        <h2>Notes</h2>
        <ul id="notes-list">
          <li>Loading field notes…</li>
        </ul>
      </section>
    </main>

    <script type="module">
      const configUrl = "config/eggs.json";
      const manifestGrid = document.querySelector("#manifest-grid");
      const checklistGrid = document.querySelector("#field-checklist-grid");
      const deviceSelectorGrid = document.querySelector("#device-selector-grid");
      const notesElement = document.querySelector("#notes-list");
      const errorBanner = document.querySelector("#error-message");
      const preflightEl = document.querySelector("#preflight");
      const heroDescription = document.querySelector("#hero-description");
      const heroTitle = document.querySelector("#hero-title");
      const chipFamilyEl = document.querySelector("#chip-family");
      const deviceTypeDisplay = document.querySelector("#device-type-display");
      
      let currentConfig = null;
      let selectedDevice = null;

      const loadInstallButton = () =>
        import(
          window.location.hostname === "localhost"
            ? "/dist/web/install-button.js"
            : "https://unpkg.com/esp-web-tools/dist/web/install-button.js?module"
        ).catch(() =>
          import("https://unpkg.com/esp-web-tools/dist/web/install-button.js?module"),
        );

      const absolute = (path) => new URL(path, location.href).toString();

      const renderDeviceSelector = (devices) => {
        deviceSelectorGrid.innerHTML = "";
        devices.forEach((device) => {
          const card = document.createElement("article");
          card.className = "device-selector-card";
          card.setAttribute("data-device-id", device.id);
          card.innerHTML = `
            <h3>${device.name}</h3>
            <p>${device.tagline}</p>
          `;
          card.addEventListener("click", () => selectDevice(device.id));
          deviceSelectorGrid.append(card);
        });
      };

      const selectDevice = (deviceId) => {
        if (!currentConfig) return;
        
        const device = currentConfig.devices.find(d => d.id === deviceId);
        if (!device) return;
        
        selectedDevice = device;
        
        // Update UI selection state
        document.querySelectorAll(".device-selector-card").forEach(card => {
          if (card.getAttribute("data-device-id") === deviceId) {
            card.classList.add("selected");
          } else {
            card.classList.remove("selected");
          }
        });
        
        // Update hero section
        heroTitle.textContent = `ESP Web Tools – ${device.name} Recovery`;
        heroDescription.textContent = device.description;
        chipFamilyEl.textContent = device.chipFamily;
        deviceTypeDisplay.textContent = device.name;
        
        // Render manifests for selected device
        renderManifests(device);
      };

      const renderChecklist = (items) => {
        checklistGrid.innerHTML = "";
        items.forEach((item) => {
          const card = document.createElement("article");
          card.className = "check-card";
          card.innerHTML = `
            <div class="check-card-header">
              <span class="check-title">${item.title}</span>
              <span class="check-marker"></span>
            </div>
            <p>${item.detail}</p>
          `;
          checklistGrid.append(card);
        });
      };

      const renderManifests = (device) => {
        manifestGrid.innerHTML = "";
        device.manifests.forEach((manifest) => {
          const card = document.createElement("article");
          card.className = "manifest-card";
          card.innerHTML = `
            <div class="card-head">
              <div>
                <p class="card-badge">${manifest.badge}</p>
                <h3>${manifest.title}</h3>
                <p class="card-summary">${manifest.summary}</p>
              </div>
              <p class="card-version">${manifest.versionLabel}</p>
            </div>
            <p class="card-note">${manifest.note}</p>
          `;
          const ctaWrapper = document.createElement("div");
          ctaWrapper.className = "card-cta";
          const button = document.createElement("esp-web-install-button");
          button.setAttribute("manifest", absolute(manifest.manifest));
          const slotButton = document.createElement("button");
          slotButton.setAttribute("slot", "activate");
          slotButton.type = "button";
          slotButton.textContent = manifest.cta;
          button.append(slotButton);
          const hint = document.createElement("p");
          hint.className = "card-hint";
          hint.textContent = `Manifest URL: ${absolute(manifest.manifest)}`;
          ctaWrapper.append(button, hint);
          card.append(ctaWrapper);
          manifestGrid.append(card);
        });
      };

      const renderNotes = (notes) => {
        notesElement.innerHTML = "";
        notes.forEach((note) => {
          const li = document.createElement("li");
          li.textContent = note;
          notesElement.append(li);
        });
      };

      const showError = (message) => {
        errorBanner.textContent = message;
        errorBanner.style.visibility = "visible";
      };

      const init = async () => {
        try {
          await loadInstallButton();
        } catch (err) {
          showError("Failed to load the ESP Web Tools component. See console for details.");
          console.error(err);
          return;
        }

        try {
          const resp = await fetch(configUrl);
          if (!resp.ok) {
            throw new Error(`Config request failed (${resp.status})`);
          }
          const config = await resp.json();
          currentConfig = config;
          
          preflightEl.textContent = config.preflight;
          renderChecklist(config.fieldChecklist);
          renderNotes(config.notes);
          
          // Render device selector
          if (config.devices && config.devices.length > 0) {
            renderDeviceSelector(config.devices);
            // Auto-select first device
            selectDevice(config.devices[0].id);
          } else {
            showError("No devices configured in the configuration file.");
          }
        } catch (err) {
          console.error(err);
          showError("Unable to load the field configuration. The manifests cannot render.");
        }
      };

      init();
    </script>
  </body>
</html>
